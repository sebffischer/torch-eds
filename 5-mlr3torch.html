<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Training Neural Networks with mlr3torch</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="5-mlr3torch_files/libs/clipboard/clipboard.min.js"></script>
<script src="5-mlr3torch_files/libs/quarto-html/quarto.js"></script>
<script src="5-mlr3torch_files/libs/quarto-html/popper.min.js"></script>
<script src="5-mlr3torch_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="5-mlr3torch_files/libs/quarto-html/anchor.min.js"></script>
<link href="5-mlr3torch_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="5-mlr3torch_files/libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="5-mlr3torch_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="5-mlr3torch_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="5-mlr3torch_files/libs/bootstrap/bootstrap-973236bd072d72a04ee9cd82dcc9cb29.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Training Neural Networks with mlr3torch</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">1. Introduction</h2>
<section id="why-use-mlr3torch" class="level3">
<h3 class="anchored" data-anchor-id="why-use-mlr3torch">Why Use <code>mlr3torch</code>?</h3>
<p>If you’re already familiar with the <code>mlr3</code> framework, integrating deep learning capabilities into your workflow becomes seamless with <code>mlr3torch</code>. Here are some compelling reasons to adopt <code>mlr3torch</code>:</p>
<ul>
<li><p><strong>Efficiency and Reusability</strong>: Avoid rewriting boilerplate code by utilizing predefined network architectures or easily building custom ones tailored to your specific needs.</p></li>
<li><p><strong>Integration into mlr3</strong>: Leverage <code>mlr3</code>’s robust features like hyperparameter tuning, preprocessing, and resampling seamlessly within the deep learning paradigm.</p></li>
<li><p><strong>Predefined Learners</strong>: <code>mlr3torch</code> provides a set of predefined learners for common tasks, such as image classification and tabular data regression.</p></li>
</ul>
</section>
</section>
<section id="brief-mlr3-recap" class="level2">
<h2 class="anchored" data-anchor-id="brief-mlr3-recap">Brief <code>mlr3</code> Recap</h2>
<ul>
<li><code>tsk()</code> creates an example <code>Task</code>, where the goal is to predict the miles-per-galleon of cars</li>
<li><code>lrn()</code> defines a simple regression tree <code>Learner</code> from the {rpart} package</li>
<li><code>rsmp()</code> sets a <code>Resampling</code> strategy</li>
<li><code>resample()</code> runs the resample experiment</li>
<li><code>msr()</code> initializes an mlr3 performance <code>Measure</code></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>tsk_mtcars <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"mtcars"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>lrn_tree <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.rpart"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>rsmp_cv <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">=</span> <span class="fu">resample</span>(</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">task       =</span> tsk_mtcars,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner    =</span> lrn_tree,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> rsmp_cv</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>INFO  [10:25:26.181] [mlr3] Applying learner 'regr.rpart' on task 'mtcars' (iter 1/3)
INFO  [10:25:26.212] [mlr3] Applying learner 'regr.rpart' on task 'mtcars' (iter 2/3)
INFO  [10:25:26.222] [mlr3] Applying learner 'regr.rpart' on task 'mtcars' (iter 3/3)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>rr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"regr.mse"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>regr.mse 
22.62893 </code></pre>
</div>
</div>
</section>
<section id="recap-of-mlr3" class="level2">
<h2 class="anchored" data-anchor-id="recap-of-mlr3">2. Recap of mlr3</h2>
<p>Before diving into <code>mlr3torch</code>, it’s essential to understand the foundational components of the <code>mlr3</code> framework.</p>
<section id="learners" class="level3">
<h3 class="anchored" data-anchor-id="learners">2.1 Learners</h3>
<p>In <code>mlr3</code>, a <strong>Learner</strong> encapsulates a machine learning algorithm. With <code>mlr3torch</code>, you can create advanced learners that utilize neural networks.</p>
<section id="creating-an-mlp-learner" class="level4">
<h4 class="anchored" data-anchor-id="creating-an-mlp-learner">Creating an MLP Learner</h4>
<p>Let’s create a Multi-Layer Perceptron (MLP) learner for a regression task and set its important parameters:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3torch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: mlr3pipelines</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: torch</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"classif.mlp"</span>,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="at">neurons =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">50</span>), <span class="co"># Two hidden layers with 50 neurons each</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="at">batch_size =</span> <span class="dv">256</span>, <span class="co"># Number of samples per gradient update</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="at">epochs =</span> <span class="dv">10</span>, <span class="co"># Number of training epochs</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="at">device =</span> <span class="st">"cpu"</span> <span class="co"># Device to train on ('cpu' or 'cuda')</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-an-example-task" class="level4">
<h4 class="anchored" data-anchor-id="creating-an-example-task">Creating an Example Task</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>task <span class="ot">&lt;-</span> <span class="fu">tsk</span>(<span class="st">"spam"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>Key Features of the Task API:</em></p>
<ul>
<li><strong>Retrieving Data</strong>: Use <code>$data()</code> to access the underlying data.</li>
<li><strong>Target Variable</strong>: Defined during task creation, specifying what the model should predict.</li>
<li><strong>Task Types</strong>: Supports various types like classification, regression, etc.</li>
</ul>
</section>
</section>
</section>
<section id="training-the-learner" class="level2">
<h2 class="anchored" data-anchor-id="training-the-learner">3. Training the Learner</h2>
<p>With the learner and task set up, the next step is to train the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Start of Selection</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the MLP learner on the German Credit task</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the trained model</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(learner<span class="sc">$</span>model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$network
An `nn_module` containing 5,552 parameters.

── Modules ─────────────────────────────────────────────────────────────────────
• 0: &lt;nn_linear&gt; #2,900 parameters
• 1: &lt;nn_relu&gt; #0 parameters
• 2: &lt;nn_dropout&gt; #0 parameters
• 3: &lt;nn_linear&gt; #2,550 parameters
• 4: &lt;nn_relu&gt; #0 parameters
• 5: &lt;nn_dropout&gt; #0 parameters
• 6: &lt;nn_linear&gt; #102 parameters

$internal_valid_scores
NULL

$loss_fn
list()

$optimizer
$optimizer$param_groups
$optimizer$param_groups[[1]]
$optimizer$param_groups[[1]]$params
[1] 1 2 3 4 5 6

$optimizer$param_groups[[1]]$lr
[1] 0.001

$optimizer$param_groups[[1]]$betas
[1] 0.900 0.999

$optimizer$param_groups[[1]]$eps
[1] 1e-08

$optimizer$param_groups[[1]]$weight_decay
[1] 0

$optimizer$param_groups[[1]]$amsgrad
[1] FALSE



$optimizer$state
$optimizer$state$`1`
$optimizer$state$`1`$step
[1] 180

$optimizer$state$`1`$exp_avg
torch_tensor
Columns 1 to 10 0.0000  0.0000  0.0000  0.0000 -0.0002 -0.0002 -0.0004  0.0000 -0.0004  0.0000
 0.0021 -0.0000  0.0012  0.0000  0.0112  0.1046  0.9930 -0.0001  0.0002  0.0002
-0.0011 -0.0001 -0.0033 -0.0003 -0.0296 -0.1737 -0.8049 -0.0001 -0.0013 -0.0004
 0.0003 -0.0000  0.0004  0.0002  0.0099  0.0781  0.4650  0.0000 -0.0000  0.0001
-0.0027  0.0000 -0.0000  0.0000  0.0001 -0.0001 -0.0008  0.0000  0.0000  0.0000
 0.0010  0.0000  0.0003  0.0002  0.0062  0.0782  0.4669  0.0001 -0.0002  0.0001
-0.0001  0.0000  0.0000 -0.0000  0.0002  0.0024  0.0080 -0.0000  0.0006  0.0000
 0.0000 -0.0000 -0.0011 -0.0001 -0.0072 -0.0220 -0.0787 -0.0000 -0.0011 -0.0001
-0.0000 -0.0000  0.0002 -0.0001  0.0009 -0.0135 -0.2453  0.0000  0.0001  0.0001
-0.0002 -0.0000 -0.0003  0.0000 -0.0029 -0.0110 -0.2607  0.0000 -0.0002 -0.0001
-0.0000  0.0000 -0.0000 -0.0000 -0.0001  0.0015  0.0011 -0.0000  0.0000 -0.0000
-0.0007  0.0000  0.0002  0.0001  0.0027  0.0131  0.3388  0.0000  0.0002 -0.0000
 0.0028 -0.0001  0.0003  0.0001  0.0114  0.1230  0.3306 -0.0000 -0.0001  0.0001
 0.0003 -0.0000  0.0016 -0.0000  0.0144  0.1019  0.9913 -0.0000  0.0007  0.0000
-0.0007  0.0000 -0.0000  0.0002  0.0019  0.0182  0.1090 -0.0001  0.0001 -0.0001
-0.0000  0.0000 -0.0006 -0.0001 -0.0027 -0.0064 -0.0226  0.0000 -0.0002 -0.0000
 0.0007 -0.0000  0.0003  0.0000  0.0076  0.0631  0.1015 -0.0000  0.0001  0.0000
 0.0052 -0.0000  0.0012 -0.0000 -0.0024  0.0342  0.2652 -0.0002  0.0005  0.0002
-0.0024  0.0000 -0.0006 -0.0002 -0.0105 -0.0848 -1.0598  0.0001  0.0000 -0.0003
 0.0011  0.0000  0.0006  0.0001  0.0050  0.0464  0.5530 -0.0000  0.0004 -0.0000
 0.0003  0.0000  0.0000 -0.0001  0.0009 -0.0050  0.0377  0.0001 -0.0001 -0.0000
 0.0018  0.0000  0.0005 -0.0001  0.0023  0.0290  0.3381  0.0001  0.0004  0.0002
-0.0041  0.0000 -0.0002  0.0000  0.0079  0.0153  0.0002  0.0000 -0.0012 -0.0000
 0.0000  0.0000  0.0000  0.0000 -0.0008 -0.0021 -0.0039  0.0000 -0.0007  0.0000
 0.0000  0.0000 -0.0002  0.0001 -0.0014 -0.0131  0.3278  0.0000  0.0001  0.0001
 0.0005  0.0000 -0.0001 -0.0001 -0.0018 -0.0393 -0.6911 -0.0001  0.0000  0.0002
 0.0006  0.0000 -0.0000  0.0000  0.0001  0.0001 -0.0002 -0.0000  0.0000  0.0000
 0.0003  0.0000  0.0000  0.0002  0.0025  0.0414  0.7938  0.0000 -0.0001 -0.0001
-0.0022 -0.0001 -0.0018 -0.0002 -0.0132 -0.1040 -0.5032 -0.0001 -0.0004 -0.0001
-0.0018  0.0000  0.0000 -0.0000 -0.0004 -0.0009 -0.0021  0.0000 -0.0001  0.0000
... [the output was truncated (use n=-1 to disable)]
[ CPUFloatType{50,57} ]

$optimizer$state$`1`$exp_avg_sq
torch_tensor
Columns 1 to 8  0.0000   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0025   0.0696   2.5744   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0001   0.0041   0.0540   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0007   0.0309   1.4843   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0002   0.0006   0.0006   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0093   0.4385  10.1552   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0004   0.0297   2.2374   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0000   0.0546   0.0563   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0010   0.0929   2.7161   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0001   0.0234   1.6364   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0004   0.0028   0.0028   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0005   0.0364   2.2223   0.0000
  0.0001   0.0000   0.0000   0.0000   0.0027   0.1139   2.8334   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0011   0.0176   1.1889   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0016   0.0596   1.4481   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0001   0.0024   0.0027   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0027   0.0434   0.2301   0.0000
  0.0001   0.0000   0.0000   0.0000   0.0060   0.3915  10.6328   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0002   0.0208   3.5586   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0003   0.0359   1.8583   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0034   0.1407   3.4622   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0033   0.1838   6.2168   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0004   0.0018   0.0019   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0005   0.0189   1.1070   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0016   0.0464   1.2061   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0008   0.0121   0.2322   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0006   0.0419   1.1671   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0000   0.0003   0.0075   0.0000
  0.0000   0.0000   0.0000   0.0000   0.0000   0.0168   0.0171   0.0000
... [the output was truncated (use n=-1 to disable)]
[ CPUFloatType{50,57} ]


$optimizer$state$`2`
$optimizer$state$`2`$step
[1] 180

$optimizer$state$`2`$exp_avg
torch_tensor
0.001 *
-0.1171
 5.5680
-15.7151
 2.4109
-0.1766
 0.8500
-0.0297
-4.4457
 1.6155
-1.9497
-0.0514
 1.6388
 2.6869
 6.5389
 0.3794
-2.0389
 1.0716
 6.3278
-4.4970
 2.4503
-0.8028
 1.8331
-2.9577
-0.4035
-0.7999
 0.0535
 0.0575
 0.9902
-5.5762
... [the output was truncated (use n=-1 to disable)]
[ CPUFloatType{50} ]

$optimizer$state$`2`$exp_avg_sq
torch_tensor
 3.1170e-09
 4.2761e-05
 1.0850e-05
 2.1858e-05
 2.5321e-08
 6.7727e-05
 3.5323e-05
 1.5022e-06
 3.6060e-05
 7.0933e-06
 8.5838e-09
 2.4160e-05
 5.3496e-05
 1.5015e-05
 1.7606e-05
 1.1938e-06
 2.7651e-06
 1.2140e-04
 2.5809e-05
 3.4091e-05
 3.2911e-05
 4.0108e-05
 7.5122e-07
 6.0171e-08
 8.8240e-06
 2.8096e-05
 1.6364e-06
 1.5832e-05
 7.7487e-07
 8.3085e-08
... [the output was truncated (use n=-1 to disable)]
[ CPUFloatType{50} ]


$optimizer$state$`3`
$optimizer$state$`3`$step
[1] 180

$optimizer$state$`3`$exp_avg
torch_tensor
Columns 1 to 10-0.0000  0.0038 -0.0037 -0.0034 -0.0002 -0.0037 -0.0004 -0.0015 -0.0016 -0.0002
-0.0000 -0.0064 -0.0011 -0.0020 -0.0000 -0.0117 -0.0001 -0.0005 -0.0024 -0.0007
 0.0000  0.0203  0.0028  0.0204  0.0002  0.0106  0.0003  0.0010  0.0296  0.0063
-0.0000 -0.0167 -0.0046 -0.0059 -0.0001 -0.0488 -0.0001 -0.0012 -0.0238 -0.0083
 0.0000  0.0369  0.0005  0.0156  0.0000  0.0293  0.0000  0.0000  0.0432  0.0114
-0.0000 -0.0091 -0.0004 -0.0035 -0.0000 -0.0086 -0.0000 -0.0001 -0.0086 -0.0033
-0.0000 -0.0149 -0.0091 -0.0038 -0.0000 -0.0119 -0.0003 -0.0026  0.0222 -0.0084
 0.0000 -0.0305 -0.0010 -0.0066 -0.0001 -0.0240 -0.0002 -0.0002 -0.0041 -0.0039
 0.0000  0.0022  0.0001  0.0008  0.0000  0.0017  0.0000  0.0000  0.0019  0.0001
-0.0002 -0.0153 -0.0107 -0.0115 -0.0003 -0.0074 -0.0009 -0.0039 -0.0607  0.0024
-0.0001  0.0066 -0.0092  0.0002 -0.0006  0.0004 -0.0007 -0.0035  0.0203 -0.0092
-0.0000 -0.0377 -0.0035 -0.0114 -0.0000 -0.0399 -0.0001 -0.0006 -0.0355 -0.0074
-0.0000  0.0910  0.0065  0.0544 -0.0001  0.1997  0.0001  0.0003  0.0642  0.0290
 0.0000  0.0265  0.0016  0.0060  0.0001  0.0556  0.0001  0.0004  0.0168  0.0018
-0.0001 -0.0289 -0.0068 -0.0069 -0.0002 -0.0956 -0.0005 -0.0026 -0.0328 -0.0080
-0.0000 -0.0017 -0.0004 -0.0016 -0.0000 -0.0048 -0.0000 -0.0001 -0.0043 -0.0008
-0.0000 -0.0199 -0.0045 -0.0013 -0.0002 -0.0063 -0.0004 -0.0013 -0.0297 -0.0028
 0.0000  0.0694  0.0024  0.0226  0.0001  0.0725  0.0002  0.0003  0.0878  0.0164
 0.0000  0.1918  0.0041  0.0584  0.0002  0.2606  0.0001  0.0004  0.0865  0.0334
 0.0000  0.0149  0.0012  0.0075  0.0000  0.0210  0.0000  0.0001  0.0058  0.0013
 0.0000  0.0334  0.0019  0.0220  0.0001  0.0794  0.0001  0.0002  0.0320  0.0111
 0.0000  0.0244  0.0012  0.0052  0.0000  0.0312  0.0001  0.0001  0.0186  0.0038
 0.0000  0.1176  0.0036  0.0397  0.0001  0.2048  0.0001  0.0005  0.1252  0.0160
-0.0000  0.0329  0.0019  0.0493  0.0003  0.0415  0.0002  0.0000  0.1154  0.0442
-0.0000 -0.0004 -0.0001 -0.0003  0.0000 -0.0013 -0.0000 -0.0000 -0.0009 -0.0001
-0.0000 -0.0451 -0.0099 -0.0232 -0.0004 -0.0899 -0.0007 -0.0022 -0.0290 -0.0131
 0.0000  0.0530  0.0007  0.0094  0.0002  0.0059  0.0003  0.0003  0.0204  0.0066
 0.0000 -0.0105 -0.0041 -0.0141 -0.0000 -0.0168 -0.0002 -0.0016 -0.0137  0.0024
 0.0000  0.0328  0.0020  0.0129  0.0001  0.0472  0.0001  0.0006  0.0610  0.0083
 0.0000  0.1959  0.0059  0.0455  0.0000  0.1615  0.0002  0.0004  0.1819  0.0289
... [the output was truncated (use n=-1 to disable)]
[ CPUFloatType{50,50} ]

$optimizer$state$`3`$exp_avg_sq
torch_tensor
Columns 1 to 10 0.0000  0.0102  0.0000  0.0102  0.0000  0.0134  0.0016  0.0000  0.0145  0.0056
 0.0000  0.0009  0.0000  0.0011  0.0000  0.0043  0.0002  0.0000  0.0005  0.0004
 0.0000  0.0243  0.0000  0.0335  0.0000  0.0232  0.0046  0.0000  0.0177  0.0085
 0.0000  0.0263  0.0000  0.0461  0.0000  0.2017  0.0044  0.0000  0.0285  0.0188
 0.0000  0.0092  0.0000  0.0062  0.0000  0.0140  0.0010  0.0000  0.0048  0.0038
 0.0000  0.0013  0.0000  0.0005  0.0000  0.0014  0.0000  0.0000  0.0005  0.0002
 0.0000  0.1511  0.0000  0.0957  0.0000  0.6489  0.0164  0.0000  0.1961  0.0542
 0.0000  0.0069  0.0000  0.0007  0.0000  0.0108  0.0008  0.0000  0.0029  0.0011
 0.0000  0.0001  0.0000  0.0000  0.0000  0.0001  0.0000  0.0000  0.0001  0.0000
 0.0000  0.1085  0.0000  0.0449  0.0000  0.1214  0.0164  0.0000  0.1261  0.0491
 0.0000  0.2593  0.0000  0.2351  0.0000  1.1219  0.0307  0.0000  0.2299  0.0853
 0.0000  0.0395  0.0000  0.0205  0.0000  0.1133  0.0028  0.0000  0.0328  0.0077
 0.0000  0.0445  0.0000  0.0680  0.0000  0.2143  0.0078  0.0000  0.0313  0.0152
 0.0000  0.0034  0.0000  0.0008  0.0000  0.0121  0.0001  0.0000  0.0017  0.0003
 0.0000  0.0882  0.0000  0.0972  0.0000  0.4151  0.0106  0.0000  0.0857  0.0253
 0.0000  0.0002  0.0000  0.0003  0.0000  0.0010  0.0001  0.0000  0.0002  0.0002
 0.0000  0.0093  0.0000  0.0034  0.0000  0.0052  0.0004  0.0000  0.0109  0.0043
 0.0000  0.0149  0.0000  0.0078  0.0000  0.0225  0.0010  0.0000  0.0120  0.0034
 0.0000  0.1516  0.0000  0.0870  0.0000  0.3451  0.0097  0.0000  0.0921  0.0370
 0.0000  0.0052  0.0000  0.0030  0.0000  0.0097  0.0008  0.0000  0.0025  0.0029
 0.0000  0.0175  0.0000  0.0170  0.0000  0.0459  0.0014  0.0000  0.0104  0.0066
 0.0000  0.0046  0.0000  0.0021  0.0000  0.0108  0.0002  0.0000  0.0029  0.0010
 0.0000  0.0606  0.0000  0.0447  0.0000  0.2084  0.0049  0.0000  0.0459  0.0226
 0.0000  0.3534  0.0000  0.2734  0.0000  0.7344  0.0426  0.0000  0.2153  0.1396
 0.0000  0.0044  0.0000  0.0054  0.0000  0.0262  0.0009  0.0000  0.0064  0.0024
 0.0000  0.2396  0.0000  0.1389  0.0000  0.6069  0.0157  0.0000  0.1341  0.0584
 0.0000  0.0510  0.0000  0.0105  0.0000  0.0078  0.0009  0.0000  0.0186  0.0024
 0.0000  0.0387  0.0000  0.0388  0.0000  0.1240  0.0054  0.0000  0.0424  0.0151
 0.0000  0.0114  0.0000  0.0047  0.0000  0.0300  0.0010  0.0000  0.0096  0.0044
 0.0000  0.1309  0.0000  0.0465  0.0000  0.1030  0.0090  0.0000  0.0514  0.0290
... [the output was truncated (use n=-1 to disable)]
[ CPUFloatType{50,50} ]


$optimizer$state$`4`
$optimizer$state$`4`$step
[1] 180

$optimizer$state$`4`$exp_avg
torch_tensor
0.01 *
-0.3462
-0.1114
 0.4390
-0.5445
 0.1619
-0.0822
-0.9443
-0.2008
 0.0166
-1.0747
-0.9752
-0.4856
 0.9247
 0.2545
-0.8651
-0.0388
-0.5338
 0.4375
 0.9484
 0.1946
 0.3996
 0.1962
 0.7774
 0.6843
-0.0123
-1.1381
 0.2330
-0.5786
 0.4007
... [the output was truncated (use n=-1 to disable)]
[ CPUFloatType{50} ]

$optimizer$state$`4`$exp_avg_sq
torch_tensor
0.0001 *
 0.1602
 0.0155
 0.8399
 0.5987
 0.1277
 0.0113
 2.9453
 0.0755
 0.0023
 1.4076
 2.9771
 0.6560
 1.4545
 0.0730
 1.4248
 0.0078
 0.2519
 0.2227
 2.7012
 0.1189
 0.4152
 0.0725
 1.2864
 7.3417
 0.0943
 2.4683
 0.1660
 0.9931
 0.2768
... [the output was truncated (use n=-1 to disable)]
[ CPUFloatType{50} ]


$optimizer$state$`5`
$optimizer$state$`5`$step
[1] 180

$optimizer$state$`5`$exp_avg
torch_tensor
Columns 1 to 10 0.0013  0.0767  0.0574  0.0160  0.4418  0.1847 -0.0704  0.0448  0.0747  0.0045
-0.0013 -0.0767 -0.0574 -0.0160 -0.4418 -0.1847  0.0704 -0.0448 -0.0747 -0.0045

Columns 11 to 20 0.0193  0.9108  0.2998  0.2597  0.0551  0.0870  0.0503  0.9432  0.6199  0.0474
-0.0193 -0.9108 -0.2998 -0.2597 -0.0551 -0.0870 -0.0503 -0.9432 -0.6199 -0.0474

Columns 21 to 30 0.3043  0.5900  0.2950  0.2011  0.2873  0.0586  0.0184  0.0233  0.1519  0.3249
-0.3043 -0.5900 -0.2950 -0.2011 -0.2873 -0.0586 -0.0184 -0.0233 -0.1519 -0.3249

Columns 31 to 40 0.0576 -0.0172  0.2725  0.6265  0.0369  0.1568  0.2584 -0.0006  0.7073  0.9281
-0.0576  0.0172 -0.2725 -0.6265 -0.0369 -0.1568 -0.2584  0.0006 -0.7073 -0.9281

Columns 41 to 50 0.0810  0.0286  0.2231  0.0044  0.0345  0.0429  0.0817  0.1260  0.0762  0.0103
-0.0810 -0.0286 -0.2231 -0.0044 -0.0345 -0.0429 -0.0817 -0.1260 -0.0762 -0.0103
[ CPUFloatType{2,50} ]

$optimizer$state$`5`$exp_avg_sq
torch_tensor
Columns 1 to 10 0.0376  0.0556  0.0863  0.4282  1.1805  0.5221  2.9791  0.0473  0.0286  0.2241
 0.0376  0.0556  0.0863  0.4282  1.1805  0.5221  2.9791  0.0473  0.0286  0.2241

Columns 11 to 20 2.1138  7.0518  0.3196  0.1380  1.5502  0.0744  0.1191  1.3568  5.6725  0.0226
 2.1138  7.0518  0.3196  0.1380  1.5502  0.0744  0.1191  1.3568  5.6725  0.0226

Columns 21 to 30 0.5437  1.0510  0.3401  3.7048  0.9323  4.4257  0.0029  1.7260  0.1895  0.3724
 0.5437  1.0510  0.3401  3.7048  0.9323  4.4257  0.0029  1.7260  0.1895  0.3724

Columns 31 to 40 0.9445  0.3682  4.0746  0.6747  0.0010  0.3360  0.1303  0.0026  4.1249  1.4801
 0.9445  0.3682  4.0746  0.6747  0.0010  0.3360  0.1303  0.0026  4.1249  1.4801

Columns 41 to 50 0.1056  0.0331  0.1158  0.0298  0.0603  0.0024  0.1220  0.0483  0.0744  0.5520
 0.1056  0.0331  0.1158  0.0298  0.0603  0.0024  0.1220  0.0483  0.0744  0.5520
[ CPUFloatType{2,50} ]


$optimizer$state$`6`
$optimizer$state$`6`$step
[1] 180

$optimizer$state$`6`$exp_avg
torch_tensor
 0.2954
-0.2954
[ CPUFloatType{2} ]

$optimizer$state$`6`$exp_avg_sq
torch_tensor
0.01 *
 4.0203
 4.0203
[ CPUFloatType{2} ]




$epochs
[1] 10

$callbacks
named list()

$seed
[1] 1630675809

$task_col_info
                   id    type       levels
               &lt;char&gt;  &lt;char&gt;       &lt;list&gt;
 1:           address numeric       [NULL]
 2:         addresses numeric       [NULL]
 3:               all numeric       [NULL]
 4:          business numeric       [NULL]
 5:        capitalAve numeric       [NULL]
 6:       capitalLong numeric       [NULL]
 7:      capitalTotal numeric       [NULL]
 8:        charDollar numeric       [NULL]
 9:   charExclamation numeric       [NULL]
10:          charHash numeric       [NULL]
11:  charRoundbracket numeric       [NULL]
12:     charSemicolon numeric       [NULL]
13: charSquarebracket numeric       [NULL]
14:        conference numeric       [NULL]
15:            credit numeric       [NULL]
16:                cs numeric       [NULL]
17:              data numeric       [NULL]
18:            direct numeric       [NULL]
19:               edu numeric       [NULL]
20:             email numeric       [NULL]
21:              font numeric       [NULL]
22:              free numeric       [NULL]
23:            george numeric       [NULL]
24:                hp numeric       [NULL]
25:               hpl numeric       [NULL]
26:          internet numeric       [NULL]
27:               lab numeric       [NULL]
28:              labs numeric       [NULL]
29:              mail numeric       [NULL]
30:              make numeric       [NULL]
31:           meeting numeric       [NULL]
32:             money numeric       [NULL]
33:            num000 numeric       [NULL]
34:           num1999 numeric       [NULL]
35:             num3d numeric       [NULL]
36:            num415 numeric       [NULL]
37:            num650 numeric       [NULL]
38:             num85 numeric       [NULL]
39:            num857 numeric       [NULL]
40:             order numeric       [NULL]
41:          original numeric       [NULL]
42:               our numeric       [NULL]
43:              over numeric       [NULL]
44:             parts numeric       [NULL]
45:            people numeric       [NULL]
46:                pm numeric       [NULL]
47:           project numeric       [NULL]
48:                re numeric       [NULL]
49:           receive numeric       [NULL]
50:            remove numeric       [NULL]
51:            report numeric       [NULL]
52:             table numeric       [NULL]
53:        technology numeric       [NULL]
54:            telnet numeric       [NULL]
55:              will numeric       [NULL]
56:               you numeric       [NULL]
57:              your numeric       [NULL]
58:              type  factor spam,nonspam
                   id    type       levels

attr(,"class")
[1] "learner_torch_model" "list"               </code></pre>
</div>
</div>
<p><em>Key Points:</em></p>
<ul>
<li>Training involves optimizing the model’s weights to minimize the loss function.</li>
<li>After training, the model can be used to make predictions on new data.</li>
</ul>
</section>
<section id="leveraging-advanced-mlr3-features" class="level2">
<h2 class="anchored" data-anchor-id="leveraging-advanced-mlr3-features">4. Leveraging Advanced mlr3 Features</h2>
<section id="cross-validation-resampling" class="level3">
<h3 class="anchored" data-anchor-id="cross-validation-resampling">4.1 Cross-Validation Resampling</h3>
<p>Cross-validation is a robust method for assessing the generalization performance of a model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">&lt;-</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>measures <span class="ot">&lt;-</span> <span class="fu">msrs</span>(<span class="fu">c</span>(<span class="st">"classif.ce"</span>, <span class="st">"classif.auc"</span>))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">&lt;-</span> <span class="fu">resample</span>(task, learner, resampling)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>INFO  [10:25:28.090] [mlr3] Applying learner 'classif.mlp' on task 'spam' (iter 1/1)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span><span class="fu">instantiate</span>(task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>Explanation:</em></p>
<ul>
<li><strong>msrs()</strong>: Specifies the performance measures to evaluate, such as Mean Squared Error (MSE) and Root Mean Squared Error (RMSE).</li>
<li><strong>resample()</strong>: Performs the resampling based on the defined strategy.</li>
<li><strong>aggregate()</strong>: Computes the average performance across all resampling iterations.</li>
</ul>
</section>
<section id="hyperparameter-tuning" class="level3">
<h3 class="anchored" data-anchor-id="hyperparameter-tuning">4.3 Hyperparameter Tuning</h3>
<p>Optimize the learner’s hyperparameters to enhance performance.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>